{% extends "base.html" %} {% block title %}Evaluaci√≥n Individual - Sistema de
Evaluaci√≥n Crediticia{% endblock %} {% block page_title %}
<span class="flex items-center gap-2">
  <svg
    class="h-6 w-6 text-primary-600"
    fill="none"
    stroke="currentColor"
    viewBox="0 0 24 24"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
    ></path>
  </svg>
  Evaluaci√≥n Individual
</span>
{% endblock %} {% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
  <!-- Formulario de Evaluaci√≥n -->
  <div class="lg:col-span-2">
    <div class="rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
      <div class="border-b border-gray-200 pb-4">
        <h2 class="text-lg font-semibold text-gray-900">
          Datos del Solicitante
        </h2>
        <p class="text-sm text-gray-500">
          Complete todos los campos para realizar la evaluaci√≥n crediticia. Los
          campos con <span class="text-red-500">*</span> son obligatorios.
        </p>
      </div>

      <form id="evaluationForm" class="mt-6 space-y-6">
        <!-- ============================================ -->
        <!-- SECCI√ìN 1: INFORMACI√ìN PERSONAL -->
        <!-- ============================================ -->
        <div class="rounded-lg border border-gray-200 p-4 bg-gray-50/50">
          <h3
            class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-4"
          >
            <svg
              class="h-5 w-5 text-blue-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            Informaci√≥n Personal del Solicitante
          </h3>

          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Nombre (opcional) -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Nombre del Solicitante
                <span class="text-gray-400 text-xs">(opcional)</span>
              </label>
              <input
                type="text"
                name="applicant_name"
                id="applicant_name"
                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                placeholder="Ej: Juan P√©rez"
              />
              <p class="mt-1 text-xs text-gray-400">
                Solo para identificaci√≥n interna
              </p>
            </div>

            <!-- Edad -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Edad del Solicitante <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <input
                  type="number"
                  name="person_age"
                  id="person_age"
                  required
                  min="18"
                  max="100"
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm pr-12"
                  placeholder="35"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-sm"
                  >a√±os</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Debe ser mayor de 18 a√±os
                </span>
              </p>
            </div>

            <!-- Ingreso Anual -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Ingreso Anual Bruto <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <span
                  class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500"
                  >$</span
                >
                <input
                  type="number"
                  name="person_income"
                  id="person_income"
                  required
                  min="1000"
                  step="100"
                  class="block w-full rounded-lg border-gray-300 pl-7 pr-16 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                  placeholder="60000"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-xs"
                  >USD/a√±o</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Ingreso total anual antes de impuestos
                </span>
              </p>
            </div>

            <!-- A√±os de Empleo -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Antig√ºedad Laboral <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <input
                  type="number"
                  name="person_emp_length"
                  id="person_emp_length"
                  required
                  min="0"
                  max="60"
                  step="0.5"
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm pr-12"
                  placeholder="5"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-sm"
                  >a√±os</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  A√±os en el empleo actual (0 si desempleado)
                </span>
              </p>
            </div>

            <!-- Tipo de Vivienda -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Tipo de Vivienda <span class="text-red-500">*</span>
              </label>
              <select
                name="person_home_ownership"
                id="person_home_ownership"
                required
                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="RENT">üè† Alquiler - Paga renta mensual</option>
                <option value="OWN">üè° Propia - Sin deuda hipotecaria</option>
                <option value="MORTGAGE">üè¶ Hipoteca - Pagando pr√©stamo</option>
                <option value="OTHER">
                  üìç Otro - Familiar, prestada, etc.
                </option>
              </select>
              <p class="mt-1 text-xs text-gray-500">
                Situaci√≥n actual de vivienda
              </p>
            </div>

            <!-- Historial Crediticio -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Historial Crediticio <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <input
                  type="number"
                  name="cb_person_cred_hist_length"
                  id="cb_person_cred_hist_length"
                  required
                  min="0"
                  max="50"
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm pr-12"
                  placeholder="4"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-sm"
                  >a√±os</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  A√±os desde su primera cuenta de cr√©dito
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- ============================================ -->
        <!-- SECCI√ìN 2: INFORMACI√ìN DEL PR√âSTAMO -->
        <!-- ============================================ -->
        <div class="rounded-lg border border-gray-200 p-4 bg-blue-50/30">
          <h3
            class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-4"
          >
            <svg
              class="h-5 w-5 text-green-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Informaci√≥n del Pr√©stamo Solicitado
          </h3>

          <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Monto del Pr√©stamo -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Monto del Pr√©stamo <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <span
                  class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500"
                  >$</span
                >
                <input
                  type="number"
                  name="loan_amnt"
                  id="loan_amnt"
                  required
                  min="500"
                  max="100000"
                  step="100"
                  class="block w-full rounded-lg border-gray-300 pl-7 pr-12 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                  placeholder="15000"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 text-xs"
                  >USD</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Cantidad que desea solicitar ($500 - $100,000)
                </span>
              </p>
            </div>

            <!-- Tasa de Inter√©s -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Tasa de Inter√©s Anual <span class="text-red-500">*</span>
              </label>
              <div class="relative mt-1">
                <input
                  type="number"
                  name="loan_int_rate"
                  id="loan_int_rate"
                  required
                  min="5"
                  max="30"
                  step="0.1"
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm pr-8"
                  placeholder="11.5"
                />
                <span
                  class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500"
                  >%</span
                >
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Tasa propuesta (5% - 30% t√≠pico)
                </span>
              </p>
            </div>

            <!-- Proporci√≥n Pr√©stamo/Ingreso (CALCULADO AUTOM√ÅTICAMENTE) -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Proporci√≥n Pr√©stamo/Ingreso
                <span class="text-blue-500 text-xs ml-1 font-normal"
                  >(autom√°tico)</span
                >
              </label>
              <div class="relative mt-1">
                <input
                  type="text"
                  name="loan_percent_income"
                  id="loan_percent_income"
                  readonly
                  class="block w-full rounded-lg border-gray-200 bg-gray-100 shadow-sm sm:text-sm cursor-not-allowed"
                  placeholder="Se calcula autom√°ticamente"
                />
              </div>
              <p class="mt-1 text-xs text-blue-600">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  = Pr√©stamo √∑ Ingreso Anual
                </span>
              </p>
              <div
                id="loan_ratio_warning"
                class="hidden mt-1 p-2 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-700"
              >
                <span class="font-medium">‚ö†Ô∏è Atenci√≥n:</span> Un ratio alto
                indica que el pr√©stamo es grande en relaci√≥n al ingreso.
              </div>
            </div>

            <!-- Prop√≥sito del Pr√©stamo -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Prop√≥sito del Pr√©stamo <span class="text-red-500">*</span>
              </label>
              <select
                name="loan_intent"
                id="loan_intent"
                required
                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="PERSONAL">üí≥ Personal - Gastos generales</option>
                <option value="EDUCATION">
                  üéì Educaci√≥n - Estudios o cursos
                </option>
                <option value="MEDICAL">üè• M√©dico - Gastos de salud</option>
                <option value="VENTURE">üíº Negocio - Emprendimiento</option>
                <option value="HOMEIMPROVEMENT">
                  üè† Mejoras del Hogar - Remodelaci√≥n
                </option>
                <option value="DEBTCONSOLIDATION">
                  üìä Consolidaci√≥n - Unificar deudas
                </option>
              </select>
              <p class="mt-1 text-xs text-gray-500">
                ¬øPara qu√© usar√° el dinero?
              </p>
            </div>

            <!-- Grado del Pr√©stamo -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Grado de Riesgo Asignado <span class="text-red-500">*</span>
              </label>
              <select
                name="loan_grade"
                id="loan_grade"
                required
                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="A">A - Excelente (menor riesgo)</option>
                <option value="B">B - Muy Bueno</option>
                <option value="C">C - Bueno</option>
                <option value="D">D - Aceptable</option>
                <option value="E">E - Regular (mayor riesgo)</option>
                <option value="F">F - Bajo</option>
                <option value="G">G - Muy Bajo (m√°ximo riesgo)</option>
              </select>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  Clasificaci√≥n preliminar del prestamista
                </span>
              </p>
            </div>

            <!-- Default Previo -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                ¬øHa incumplido pagos antes? <span class="text-red-500">*</span>
              </label>
              <select
                name="cb_person_default_on_file"
                id="cb_person_default_on_file"
                required
                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="N">‚úÖ No - Sin incumplimientos previos</option>
                <option value="Y">‚ùå S√≠ - Tiene historial de default</option>
              </select>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  ¬øAparece en bur√≥ de cr√©dito con incumplimientos?
                </span>
              </p>
            </div>

            <!-- Plazo Deseado (nuevo campo) -->
            <div>
              <label class="block text-sm font-medium text-gray-700">
                Plazo Deseado
                <span class="text-gray-400 text-xs ml-1 font-normal">(opcional)</span>
              </label>
              <div class="relative mt-1">
                <select
                  name="desired_term_months"
                  id="desired_term_months"
                  class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm"
                >
                  <option value="">Autom√°tico seg√∫n perfil</option>
                  <option value="12">12 meses (1 a√±o)</option>
                  <option value="24">24 meses (2 a√±os)</option>
                  <option value="36">36 meses (3 a√±os)</option>
                  <option value="48">48 meses (4 a√±os)</option>
                  <option value="60">60 meses (5 a√±os)</option>
                </select>
              </div>
              <p class="mt-1 text-xs text-gray-500">
                <span class="inline-flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                      clip-rule="evenodd"
                    ></path>
                  </svg>
                  El sistema ajustar√° seg√∫n su score crediticio
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- Resumen de datos (preview) -->
        <div
          id="formSummary"
          class="hidden rounded-lg border border-blue-200 bg-blue-50 p-4"
        >
          <h4 class="text-sm font-semibold text-blue-800 mb-2">
            üìã Resumen de la Solicitud
          </h4>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
            <div>
              <span class="text-blue-600">Pr√©stamo:</span>
              <span id="summaryLoan" class="font-medium text-blue-900">-</span>
            </div>
            <div>
              <span class="text-blue-600">Ingreso:</span>
              <span id="summaryIncome" class="font-medium text-blue-900"
                >-</span
              >
            </div>
            <div>
              <span class="text-blue-600">Ratio:</span>
              <span id="summaryRatio" class="font-medium text-blue-900">-</span>
            </div>
            <div>
              <span class="text-blue-600">Tasa:</span>
              <span id="summaryRate" class="font-medium text-blue-900">-</span>
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div
          class="flex items-center justify-between border-t border-gray-200 pt-6"
        >
          <p class="text-sm text-gray-500">
            <span class="text-red-500">*</span> Campos obligatorios
          </p>
          <div class="flex gap-3">
            <button
              type="button"
              onclick="resetForm()"
              class="rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
            >
              Limpiar
            </button>
            <button
              type="submit"
              id="submitBtn"
              class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-6 py-2.5 text-sm font-medium text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Evaluar Solicitud
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Panel de Resultados -->
  <div class="lg:col-span-1">
    <div
      id="resultPanel"
      class="sticky top-20 rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-200"
    >
      <!-- Estado inicial -->
      <div id="resultInitial" class="text-center py-12">
        <div
          class="mx-auto h-16 w-16 rounded-full bg-gray-100 flex items-center justify-center"
        >
          <svg
            class="h-8 w-8 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            ></path>
          </svg>
        </div>
        <h3 class="mt-4 text-sm font-semibold text-gray-900">Sin evaluaci√≥n</h3>
        <p class="mt-2 text-sm text-gray-500">
          Complete el formulario y haga clic en "Evaluar Solicitud" para ver los
          resultados.
        </p>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg text-left">
          <h4 class="text-sm font-medium text-blue-800">
            üí° ¬øQu√© eval√∫a este sistema?
          </h4>
          <ul class="mt-2 text-xs text-blue-700 space-y-1">
            <li>
              ‚Ä¢ <strong>Score Crediticio</strong>: Puntuaci√≥n de 300 a 850
            </li>
            <li>
              ‚Ä¢ <strong>Probabilidad de Default</strong>: Riesgo de impago
            </li>
            <li>
              ‚Ä¢ <strong>Monto Recomendado</strong>: Cantidad segura a prestar
            </li>
            <li>‚Ä¢ <strong>Tasa Sugerida</strong>: Inter√©s seg√∫n el perfil</li>
          </ul>
        </div>
      </div>

      <!-- Resultado de evaluaci√≥n -->
      <div id="resultContent" class="hidden">
        <!-- Score -->
        <div class="text-center">
          <p class="text-sm font-medium text-gray-500">Score Crediticio</p>
          <div class="mt-2 flex items-center justify-center gap-2">
            <span id="resultScore" class="text-5xl font-bold"></span>
            <span id="resultEmoji" class="text-3xl"></span>
          </div>
          <span
            id="resultCategory"
            class="mt-1 inline-block rounded-full px-3 py-1 text-sm font-medium"
          ></span>
        </div>

        <!-- Barra de Score -->
        <div class="mt-6">
          <div class="h-4 w-full rounded-full score-meter">
            <div id="scoreIndicator" class="relative h-full">
              <div
                class="absolute top-0 h-4 w-1 bg-gray-800 rounded"
                style="left: 0%"
              ></div>
            </div>
          </div>
          <div class="mt-1 flex justify-between text-xs text-gray-500">
            <span>300</span>
            <span>580</span>
            <span>670</span>
            <span>740</span>
            <span>850</span>
          </div>
          <div class="mt-1 flex justify-between text-xs">
            <span class="text-red-500">Pobre</span>
            <span class="text-yellow-500">Regular</span>
            <span class="text-green-500">Bueno</span>
            <span class="text-green-600">Muy Bueno</span>
            <span class="text-green-700">Excelente</span>
          </div>
        </div>

        <!-- Decisi√≥n -->
        <div id="resultDecision" class="mt-6 rounded-lg p-4 text-center">
          <p class="text-sm font-medium">Decisi√≥n Final</p>
          <p id="resultDecisionText" class="text-xl font-bold mt-1"></p>
        </div>

        <!-- M√©tricas de Riesgo -->
        <div class="mt-6 space-y-3">
          <h4 class="text-sm font-semibold text-gray-700">
            An√°lisis de Riesgo
          </h4>
          <div
            class="flex items-center justify-between rounded-lg bg-gray-50 p-3"
          >
            <span class="text-sm text-gray-600">Probabilidad de Impago</span>
            <span id="resultProbDefault" class="text-sm font-semibold"></span>
          </div>
          <div
            class="flex items-center justify-between rounded-lg bg-gray-50 p-3"
          >
            <span class="text-sm text-gray-600">Nivel de Riesgo</span>
            <span id="resultRiskLevel" class="text-sm font-semibold"></span>
          </div>
          <div
            class="flex items-center justify-between rounded-lg bg-gray-50 p-3"
          >
            <span class="text-sm text-gray-600">Confianza del Modelo</span>
            <span id="resultConfidence" class="text-sm font-semibold"></span>
          </div>
        </div>

        <!-- Secci√≥n cuando APROBADO -->
        <div id="approvedSection" class="mt-6 border-t border-gray-200 pt-6 hidden">
          <h4 class="text-sm font-semibold text-green-700">
            ‚úÖ Pr√©stamo Aprobado
          </h4>
          <div class="mt-3 space-y-2">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Monto Aprobado</span>
              <span id="resultApprovedAmount" class="font-semibold text-green-600"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tasa de Inter√©s</span>
              <span id="resultSuggestedRate" class="font-semibold text-gray-900"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Plazo</span>
              <span id="resultMaxTerm" class="font-semibold text-gray-900"></span>
            </div>
            <div class="flex justify-between text-sm border-t border-gray-200 pt-2 mt-2">
              <span class="text-gray-600">Pago Mensual Estimado</span>
              <span id="resultMonthlyPayment" class="font-semibold text-primary-600"></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Total a Pagar</span>
              <span id="resultTotalPayment" class="font-semibold text-gray-700"></span>
            </div>
          </div>
        </div>

        <!-- Secci√≥n cuando RECHAZADO -->
        <div id="rejectedSection" class="mt-6 border-t border-gray-200 pt-6 hidden">
          <h4 class="text-sm font-semibold text-red-700">
            ‚ùå Pr√©stamo No Aprobado
          </h4>
          <div class="mt-3 p-4 bg-red-50 rounded-lg border border-red-200">
            <p class="text-sm text-red-800 font-medium">
              La solicitud no cumple con los criterios m√≠nimos de aprobaci√≥n.
            </p>
            <div class="mt-3 text-sm text-red-700">
              <p class="font-medium mb-2">Razones principales:</p>
              <ul id="rejectionReasons" class="list-disc list-inside space-y-1">
                <!-- Din√°mico -->
              </ul>
            </div>
          </div>
          
          <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
            <h5 class="text-sm font-semibold text-blue-800">üí° Para mejorar sus posibilidades:</h5>
            <ul id="improvementTips" class="mt-2 text-sm text-blue-700 space-y-1">
              <!-- Din√°mico -->
            </ul>
          </div>
        </div>

        <!-- Condiciones (solo para aprobados) -->
        <div
          id="conditionsSection"
          class="mt-6 border-t border-gray-200 pt-6 hidden"
        >
          <h4 class="text-sm font-semibold text-gray-700">
            üìã Condiciones y Observaciones
          </h4>
          <ul id="resultConditions" class="mt-3 space-y-2 text-sm"></ul>
        </div>

        <!-- Explicaci√≥n del Resultado (NUEVO) -->
        <div
          id="explanationSection"
          class="mt-6 border-t border-gray-200 pt-6"
        >
          <h4 class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ¬øPor qu√© este resultado?
          </h4>
          <div id="explanationContent" class="mt-3 space-y-2 text-sm">
            <!-- Din√°micamente generado por JS -->
          </div>
          <details class="mt-3 text-xs">
            <summary class="cursor-pointer text-blue-600 hover:text-blue-700 font-medium">
              üí° Entender mejor la predicci√≥n
            </summary>
            <div class="mt-2 p-3 bg-blue-50 rounded-lg text-gray-600 space-y-2">
              <p><strong>El modelo de Machine Learning</strong> analiza patrones de miles de pr√©stamos hist√≥ricos para identificar qu√© combinaciones de factores predicen mejor el riesgo de impago.</p>
              <p><strong>No es un sistema de reglas fijas</strong> - aprende relaciones complejas entre las variables. Por ejemplo, un "Grade A" no garantiza aprobaci√≥n si otros factores (como bajo ingreso) indican riesgo.</p>
              <p><strong>Factores m√°s influyentes:</strong> ingreso anual, ratio pr√©stamo/ingreso, historial de default, a√±os de empleo y prop√≥sito del pr√©stamo.</p>
            </div>
          </details>
        </div>

        <!-- Sanity Check Notice (solo si se ajust√≥) -->
        <div id="sanityCheckSection" class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200 hidden">
          <div class="flex items-start gap-2">
            <span class="text-purple-600">üîß</span>
            <div class="text-sm">
              <p class="font-medium text-purple-800">Ajuste de Sentido Com√∫n Aplicado</p>
              <p id="sanityCheckReason" class="text-purple-700 mt-1"></p>
              <p id="sanityCheckOriginal" class="text-xs text-purple-600 mt-1"></p>
            </div>
          </div>
        </div>

        <!-- Bot√≥n Nueva Evaluaci√≥n -->
        <button
          onclick="resetForm(); hideResult();"
          class="mt-6 w-full rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 transition-colors"
        >
          üîÑ Nueva Evaluaci√≥n
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Ejemplos de Clientes -->
<div class="mt-8 rounded-xl bg-white p-6 shadow-sm ring-1 ring-gray-200">
  <h3 class="text-lg font-semibold text-gray-900">üìä Perfiles de Ejemplo</h3>
  <p class="text-sm text-gray-500">
    Haga clic en un perfil para cargar datos de prueba autom√°ticamente
  </p>

  <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-3">
    <!-- Cliente Premium -->
    <button
      onclick="loadExample('premium')"
      class="group rounded-lg border-2 border-green-200 bg-green-50 p-4 text-left transition-all hover:border-green-400 hover:shadow-md"
    >
      <div class="flex items-center gap-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-full bg-green-200 text-green-700"
        >
          üåü
        </div>
        <div>
          <p class="font-semibold text-gray-900">Cliente Premium</p>
          <p class="text-xs text-green-600 font-medium">
            Score esperado: 750-850
          </p>
        </div>
      </div>
      <div class="mt-3 text-xs text-gray-600 space-y-0.5">
        <p>‚Ä¢ 45 a√±os, $120,000/a√±o</p>
        <p>‚Ä¢ 15 a√±os de empleo, casa propia</p>
        <p>‚Ä¢ Pr√©stamo $25,000 (21% del ingreso)</p>
        <p>‚Ä¢ Sin historial de incumplimiento</p>
      </div>
    </button>

    <!-- Cliente Regular -->
    <button
      onclick="loadExample('regular')"
      class="group rounded-lg border-2 border-yellow-200 bg-yellow-50 p-4 text-left transition-all hover:border-yellow-400 hover:shadow-md"
    >
      <div class="flex items-center gap-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-full bg-yellow-200 text-yellow-700"
        >
          üë§
        </div>
        <div>
          <p class="font-semibold text-gray-900">Cliente Regular</p>
          <p class="text-xs text-yellow-600 font-medium">
            Score esperado: 620-700
          </p>
        </div>
      </div>
      <div class="mt-3 text-xs text-gray-600 space-y-0.5">
        <p>‚Ä¢ 32 a√±os, $55,000/a√±o</p>
        <p>‚Ä¢ 4 a√±os de empleo, alquiler</p>
        <p>‚Ä¢ Pr√©stamo $15,000 (27% del ingreso)</p>
        <p>‚Ä¢ Sin historial de incumplimiento</p>
      </div>
    </button>

    <!-- Cliente Riesgoso -->
    <button
      onclick="loadExample('risky')"
      class="group rounded-lg border-2 border-red-200 bg-red-50 p-4 text-left transition-all hover:border-red-400 hover:shadow-md"
    >
      <div class="flex items-center gap-3">
        <div
          class="flex h-10 w-10 items-center justify-center rounded-full bg-red-200 text-red-700"
        >
          ‚ö†Ô∏è
        </div>
        <div>
          <p class="font-semibold text-gray-900">Cliente Riesgoso</p>
          <p class="text-xs text-red-600 font-medium">
            Score esperado: 350-500
          </p>
        </div>
      </div>
      <div class="mt-3 text-xs text-gray-600 space-y-0.5">
        <p>‚Ä¢ 23 a√±os, $28,000/a√±o</p>
        <p>‚Ä¢ 1 a√±o de empleo, alquiler</p>
        <p>‚Ä¢ Pr√©stamo $20,000 (71% del ingreso)</p>
        <p>‚Ä¢ CON historial de incumplimiento</p>
      </div>
    </button>
  </div>
</div>

<!-- Gu√≠a de Interpretaci√≥n -->
<div
  class="mt-6 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50 p-6 ring-1 ring-blue-200"
>
  <h3 class="text-lg font-semibold text-gray-900">üìñ Gu√≠a de Interpretaci√≥n</h3>

  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Interpretaci√≥n del Score -->
    <div>
      <h4 class="text-sm font-semibold text-gray-700 mb-2">
        Score Crediticio (300-850)
      </h4>
      <div class="space-y-1 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-600"></span>
          <span
            ><strong>800-850 Excelente:</strong> Mejor tasa, m√°ximo monto</span
          >
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span
            ><strong>740-799 Muy Bueno:</strong> Muy buenas condiciones</span
          >
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span><strong>670-739 Bueno:</strong> Aprobado est√°ndar</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-orange-500"></span>
          <span
            ><strong>580-669 Regular:</strong> Aprobado con condiciones</span
          >
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span><strong>300-579 Pobre:</strong> Alto riesgo de rechazo</span>
        </div>
      </div>
    </div>

    <!-- Qu√© significa la proporci√≥n -->
    <div>
      <h4 class="text-sm font-semibold text-gray-700 mb-2">
        Proporci√≥n Pr√©stamo/Ingreso
      </h4>
      <p class="text-sm text-gray-600 mb-2">
        Esta m√©trica indica qu√© porcentaje de tu ingreso anual representa el
        pr√©stamo solicitado.
      </p>
      <div class="space-y-1 text-sm">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs"
            >0.10 = 10%</span
          >
          <span>Muy conservador</span>
        </div>
        <div class="flex items-center gap-2">
          <span
            class="px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs"
            >0.25 = 25%</span
          >
          <span>Razonable</span>
        </div>
        <div class="flex items-center gap-2">
          <span
            class="px-2 py-0.5 rounded bg-orange-100 text-orange-700 text-xs"
            >0.40 = 40%</span
          >
          <span>Elevado</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs"
            >&gt;0.50 = &gt;50%</span
          >
          <span>Alto riesgo</span>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script>
  // Ejemplos de clientes con datos realistas
  const examples = {
    premium: {
      applicant_name: "Carlos Mendoza",
      person_age: 45,
      person_income: 120000,
      person_home_ownership: "OWN",
      person_emp_length: 15,
      loan_intent: "HOMEIMPROVEMENT",
      loan_grade: "A",
      loan_amnt: 25000,
      loan_int_rate: 7.5,
      cb_person_default_on_file: "N",
      cb_person_cred_hist_length: 12,
    },
    regular: {
      applicant_name: "Mar√≠a Garc√≠a",
      person_age: 32,
      person_income: 55000,
      person_home_ownership: "RENT",
      person_emp_length: 4,
      loan_intent: "PERSONAL",
      loan_grade: "C",
      loan_amnt: 15000,
      loan_int_rate: 13.5,
      cb_person_default_on_file: "N",
      cb_person_cred_hist_length: 5,
    },
    risky: {
      applicant_name: "Roberto S√°nchez",
      person_age: 23,
      person_income: 28000,
      person_home_ownership: "RENT",
      person_emp_length: 1,
      loan_intent: "VENTURE",
      loan_grade: "E",
      loan_amnt: 20000,
      loan_int_rate: 18.5,
      cb_person_default_on_file: "Y",
      cb_person_cred_hist_length: 2,
    },
  };

  // Cargar ejemplo
  function loadExample(type) {
    const data = examples[type];
    for (const [key, value] of Object.entries(data)) {
      const input = document.getElementById(key);
      if (input) {
        input.value = value;
      }
    }
    // Recalcular la proporci√≥n despu√©s de cargar
    calculateLoanPercent();
    updateFormSummary();
    showToast(
      `Perfil "${type}" cargado. Haga clic en "Evaluar Solicitud".`,
      "info"
    );
  }

  // Resetear formulario
  function resetForm() {
    document.getElementById("evaluationForm").reset();
    document.getElementById("formSummary").classList.add("hidden");
    document.getElementById("loan_ratio_warning").classList.add("hidden");
    document.getElementById("loan_percent_income").value = "";
  }

  // Ocultar resultado
  function hideResult() {
    document.getElementById("resultInitial").classList.remove("hidden");
    document.getElementById("resultContent").classList.add("hidden");
  }

  // Calcular proporci√≥n pr√©stamo/ingreso
  function calculateLoanPercent() {
    const loanAmnt =
      parseFloat(document.getElementById("loan_amnt").value) || 0;
    const income =
      parseFloat(document.getElementById("person_income").value) || 0;

    if (income > 0 && loanAmnt > 0) {
      const percent = loanAmnt / income;
      // Mostrar como porcentaje para el usuario, pero guardar el ratio real
      document.getElementById("loan_percent_income").value =
        (percent * 100).toFixed(1) + "% (ratio: " + percent.toFixed(2) + ")";
      document.getElementById("loan_percent_income").dataset.rawValue =
        percent.toFixed(4);

      // Mostrar advertencia si el ratio es alto
      const warning = document.getElementById("loan_ratio_warning");
      if (percent > 0.4) {
        warning.classList.remove("hidden");
        warning.innerHTML = `<span class="font-medium">‚ö†Ô∏è Ratio alto (${(
          percent * 100
        ).toFixed(
          0
        )}%):</span> El pr√©stamo representa m√°s del 40% de tu ingreso anual. Esto puede afectar negativamente la evaluaci√≥n.`;
      } else {
        warning.classList.add("hidden");
      }

      updateFormSummary();
    } else {
      document.getElementById("loan_percent_income").value = "";
      document.getElementById("loan_percent_income").dataset.rawValue = "";
    }
  }

  // Actualizar resumen del formulario
  function updateFormSummary() {
    const loan = document.getElementById("loan_amnt").value;
    const income = document.getElementById("person_income").value;
    const rate = document.getElementById("loan_int_rate").value;

    if (loan && income) {
      document.getElementById("formSummary").classList.remove("hidden");
      document.getElementById("summaryLoan").textContent = formatCurrency(
        parseFloat(loan)
      );
      document.getElementById("summaryIncome").textContent = formatCurrency(
        parseFloat(income)
      );

      const ratio = parseFloat(loan) / parseFloat(income);
      document.getElementById("summaryRatio").textContent =
        (ratio * 100).toFixed(0) + "%";
      document.getElementById("summaryRate").textContent = rate
        ? rate + "%"
        : "-";
    }
  }

  // Mostrar resultado
  function showResult(data) {
    document.getElementById("resultInitial").classList.add("hidden");
    document.getElementById("resultContent").classList.remove("hidden");

    const evaluation = data.evaluation;
    const score = evaluation.credit_score;
    const risk = evaluation.risk_assessment;
    const loan = evaluation.loan_recommendation;
    const decision = evaluation.final_decision;

    // Score
    document.getElementById("resultScore").textContent = score.score;
    document.getElementById("resultEmoji").textContent = score.emoji;
    document.getElementById("resultCategory").textContent = score.category;
    document.getElementById("resultCategory").style.backgroundColor =
      score.color + "20";
    document.getElementById("resultCategory").style.color = score.color;

    // Indicador de score en la barra
    const scorePercent = ((score.score - 300) / 550) * 100;
    document.querySelector("#scoreIndicator div").style.left =
      Math.min(100, Math.max(0, scorePercent)) + "%";

    // Decisi√≥n
    const decisionEl = document.getElementById("resultDecision");
    document.getElementById("resultDecisionText").textContent =
      decision.decision;

    if (decision.decision === "APROBADO") {
      decisionEl.className =
        "mt-6 rounded-lg p-4 text-center bg-green-100 text-green-800 border border-green-200";
    } else if (decision.decision === "APROBADO CON CONDICIONES") {
      decisionEl.className =
        "mt-6 rounded-lg p-4 text-center bg-yellow-100 text-yellow-800 border border-yellow-200";
    } else {
      decisionEl.className =
        "mt-6 rounded-lg p-4 text-center bg-red-100 text-red-800 border border-red-200";
    }

    // M√©tricas de riesgo con colores
    const probDefault = risk.probability_default * 100;
    const probEl = document.getElementById("resultProbDefault");
    probEl.textContent = probDefault.toFixed(1) + "%";
    probEl.className =
      "text-sm font-semibold " +
      (probDefault > 50
        ? "text-red-600"
        : probDefault > 30
        ? "text-yellow-600"
        : "text-green-600");

    const riskEl = document.getElementById("resultRiskLevel");
    riskEl.textContent = risk.risk_level;
    riskEl.className =
      "text-sm font-semibold " +
      (risk.risk_level === "ALTO" ? "text-red-600" : "text-green-600");

    document.getElementById("resultConfidence").textContent =
      (risk.confidence * 100).toFixed(1) + "%";

    // Mostrar secci√≥n apropiada seg√∫n decisi√≥n
    const isRejected = decision.decision === "RECHAZADO";
    const approvedSection = document.getElementById("approvedSection");
    const rejectedSection = document.getElementById("rejectedSection");
    const conditionsSection = document.getElementById("conditionsSection");
    
    if (isRejected) {
      // Mostrar secci√≥n de RECHAZADO
      approvedSection.classList.add("hidden");
      rejectedSection.classList.remove("hidden");
      conditionsSection.classList.add("hidden");
      
      // Generar razones de rechazo
      generateRejectionReasons(data.input, evaluation);
      
    } else {
      // Mostrar secci√≥n de APROBADO
      approvedSection.classList.remove("hidden");
      rejectedSection.classList.add("hidden");
      
      // Llenar datos de pr√©stamo aprobado
      document.getElementById("resultApprovedAmount").textContent = 
        formatCurrency(loan.approved_amount);
      document.getElementById("resultSuggestedRate").textContent =
        loan.suggested_rate.toFixed(2) + "%";
      document.getElementById("resultMaxTerm").textContent =
        loan.max_term_months + " meses";
      document.getElementById("resultMonthlyPayment").textContent =
        formatCurrency(loan.monthly_payment);
      document.getElementById("resultTotalPayment").textContent =
        formatCurrency(loan.monthly_payment * loan.max_term_months);
      
      // Mostrar condiciones si hay
      const conditionsList = document.getElementById("resultConditions");
      conditionsList.innerHTML = "";
      
      if (loan.conditions && loan.conditions.length > 0) {
        conditionsSection.classList.remove("hidden");
        loan.conditions.forEach((condition) => {
          const li = document.createElement("li");
          li.className = "flex items-start gap-2 text-gray-600 p-2 bg-gray-50 rounded";
          li.innerHTML = `<span>${condition}</span>`;
          conditionsList.appendChild(li);
        });
      } else {
        conditionsSection.classList.add("hidden");
      }
    }

    // Mostrar Sanity Check si se aplic√≥
    const sanityCheckSection = document.getElementById("sanityCheckSection");
    if (evaluation.sanity_check && evaluation.sanity_check.was_adjusted) {
      sanityCheckSection.classList.remove("hidden");
      document.getElementById("sanityCheckReason").textContent = 
        evaluation.sanity_check.reason;
      document.getElementById("sanityCheckOriginal").textContent = 
        `El modelo ML originalmente predijo ${(evaluation.sanity_check.original_prob_default * 100).toFixed(0)}% de riesgo, 
        ajustado a ${(evaluation.risk_assessment.probability_default * 100).toFixed(1)}% por reglas de sentido com√∫n.`;
    } else {
      sanityCheckSection.classList.add("hidden");
    }

    // Generar explicaci√≥n del resultado
    generateExplanation(data, evaluation);
  }

  // Funci√≥n para generar razones de rechazo y tips de mejora
  function generateRejectionReasons(input, evaluation) {
    const reasonsList = document.getElementById("rejectionReasons");
    const tipsList = document.getElementById("improvementTips");
    reasonsList.innerHTML = "";
    tipsList.innerHTML = "";
    
    const reasons = [];
    const tips = [];
    const probDefault = evaluation.risk_assessment.probability_default * 100;
    const score = evaluation.credit_score.score;
    
    // Analizar factores negativos
    if (probDefault > 70) {
      reasons.push(`Probabilidad de impago muy alta (${probDefault.toFixed(0)}%)`);
    } else if (probDefault > 50) {
      reasons.push(`Probabilidad de impago elevada (${probDefault.toFixed(0)}%)`);
    }
    
    if (score < 580) {
      reasons.push(`Score crediticio bajo (${score} de 850)`);
      tips.push("Mejorar historial crediticio pagando deudas existentes a tiempo");
    }
    
    if (input.cb_person_default_on_file === "Y") {
      reasons.push("Historial de incumplimiento previo en bur√≥ de cr√©dito");
      tips.push("Esperar a que el historial negativo expire (usualmente 5-7 a√±os)");
    }
    
    if (input.person_income < 30000) {
      reasons.push(`Ingreso anual bajo ($${input.person_income.toLocaleString()})`);
      tips.push("Aumentar ingresos demostrables o agregar co-deudor");
    }
    
    if (input.person_emp_length < 2) {
      reasons.push(`Antig√ºedad laboral corta (${input.person_emp_length} a√±os)`);
      tips.push("Esperar a tener al menos 2 a√±os en el empleo actual");
    }
    
    const ratio = input.loan_percent_income || (input.loan_amnt / input.person_income);
    if (ratio > 0.4) {
      reasons.push(`Pr√©stamo muy alto respecto al ingreso (${(ratio*100).toFixed(0)}%)`);
      tips.push("Solicitar un monto menor o aumentar ingresos");
    }
    
    if (input.loan_grade === "E" || input.loan_grade === "F" || input.loan_grade === "G") {
      reasons.push(`Grado de riesgo asignado muy bajo (${input.loan_grade})`);
    }
    
    if (input.person_age > 70) {
      reasons.push(`Edad avanzada (${input.person_age} a√±os) representa mayor riesgo`);
    }
    
    if (input.loan_intent === "VENTURE") {
      tips.push("Considerar otros prop√≥sitos de pr√©stamo con menor riesgo (personal, educaci√≥n)");
    }
    
    // Si no hay razones espec√≠ficas, agregar gen√©rica
    if (reasons.length === 0) {
      reasons.push("La combinaci√≥n de factores indica alto riesgo de impago");
    }
    
    // Si no hay tips, agregar gen√©ricos
    if (tips.length === 0) {
      tips.push("Reducir el monto solicitado");
      tips.push("Mejorar el historial crediticio antes de volver a aplicar");
    }
    
    // Renderizar razones
    reasons.forEach(reason => {
      const li = document.createElement("li");
      li.textContent = reason;
      reasonsList.appendChild(li);
    });
    
    // Renderizar tips
    tips.forEach(tip => {
      const li = document.createElement("li");
      li.innerHTML = `‚Ä¢ ${tip}`;
      tipsList.appendChild(li);
    });
  }

  // Nueva funci√≥n para generar explicaci√≥n
  function generateExplanation(data, evaluation) {
    const explanationEl = document.getElementById("explanationContent");
    explanationEl.innerHTML = "";
    
    const factors = [];
    const input = data.input || {};
    const risk = evaluation.risk_assessment;
    const score = evaluation.credit_score.score;
    const probDefault = risk.probability_default * 100;
    
    // Analizar ingreso
    const income = input.person_income || 0;
    if (income < 30000) {
      factors.push({
        icon: "‚ùå",
        text: `Ingreso anual muy bajo ($${income.toLocaleString()}/a√±o)`,
        impact: "negativo",
        detail: "El modelo considera $30,000+/a√±o como m√≠nimo seguro para pr√©stamos"
      });
    } else if (income < 50000) {
      factors.push({
        icon: "‚ö†Ô∏è",
        text: `Ingreso anual moderado ($${income.toLocaleString()}/a√±o)`,
        impact: "neutro",
        detail: "Ingresos en el rango t√≠pico del dataset"
      });
    } else {
      factors.push({
        icon: "‚úÖ",
        text: `Ingreso anual s√≥lido ($${income.toLocaleString()}/a√±o)`,
        impact: "positivo",
        detail: "Ingresos superiores al promedio del dataset"
      });
    }
    
    // Analizar ratio pr√©stamo/ingreso
    const ratio = (input.loan_percent_income || 0);
    if (ratio > 0.4) {
      factors.push({
        icon: "‚ùå",
        text: `Ratio pr√©stamo/ingreso muy alto (${(ratio*100).toFixed(0)}%)`,
        impact: "negativo",
        detail: "El pr√©stamo representa m√°s del 40% del ingreso anual"
      });
    } else if (ratio > 0.25) {
      factors.push({
        icon: "‚ö†Ô∏è",
        text: `Ratio pr√©stamo/ingreso elevado (${(ratio*100).toFixed(0)}%)`,
        impact: "neutro",
        detail: "El pr√©stamo est√° entre el 25-40% del ingreso"
      });
    } else if (ratio > 0) {
      factors.push({
        icon: "‚úÖ",
        text: `Ratio pr√©stamo/ingreso saludable (${(ratio*100).toFixed(0)}%)`,
        impact: "positivo",
        detail: "El pr√©stamo es menor al 25% del ingreso"
      });
    }
    
    // Analizar historial de default
    if (input.cb_person_default_on_file === "Y") {
      factors.push({
        icon: "‚ùå",
        text: "Historial de incumplimiento previo",
        impact: "negativo",
        detail: "Existe registro de default en bur√≥ de cr√©dito"
      });
    } else {
      factors.push({
        icon: "‚úÖ",
        text: "Sin historial de incumplimiento",
        impact: "positivo",
        detail: "Historial crediticio limpio"
      });
    }
    
    // Analizar empleo
    const empLength = input.person_emp_length || 0;
    if (empLength < 2) {
      factors.push({
        icon: "‚ö†Ô∏è",
        text: `Antig√ºedad laboral corta (${empLength} a√±os)`,
        impact: "neutro",
        detail: "Menos de 2 a√±os en el empleo actual"
      });
    } else if (empLength >= 5) {
      factors.push({
        icon: "‚úÖ",
        text: `Antig√ºedad laboral estable (${empLength} a√±os)`,
        impact: "positivo",
        detail: "M√°s de 5 a√±os de estabilidad laboral"
      });
    }
    
    // Analizar prop√≥sito del pr√©stamo
    const riskyPurposes = ["VENTURE", "DEBTCONSOLIDATION"];
    if (riskyPurposes.includes(input.loan_intent)) {
      factors.push({
        icon: "‚ö†Ô∏è",
        text: `Prop√≥sito de alto riesgo (${input.loan_intent})`,
        impact: "neutro",
        detail: "Los pr√©stamos para negocio o consolidaci√≥n tienen mayor tasa de impago hist√≥ricamente"
      });
    }
    
    // Analizar edad con ingreso
    const age = input.person_age || 0;
    if (age > 55 && income < 50000) {
      factors.push({
        icon: "‚ö†Ô∏è",
        text: `Combinaci√≥n de edad (${age}) e ingreso bajo`,
        impact: "neutro",
        detail: "El modelo detecta mayor riesgo en personas cercanas a jubilaci√≥n con ingresos limitados"
      });
    }
    
    // Render factores
    factors.forEach(factor => {
      const div = document.createElement("div");
      div.className = `flex items-start gap-2 p-2 rounded ${
        factor.impact === "negativo" ? "bg-red-50" : 
        factor.impact === "positivo" ? "bg-green-50" : "bg-yellow-50"
      }`;
      div.innerHTML = `
        <span class="text-lg">${factor.icon}</span>
        <div>
          <p class="font-medium ${
            factor.impact === "negativo" ? "text-red-700" : 
            factor.impact === "positivo" ? "text-green-700" : "text-yellow-700"
          }">${factor.text}</p>
          <p class="text-xs text-gray-500">${factor.detail}</p>
        </div>
      `;
      explanationEl.appendChild(div);
    });
    
    // Mensaje resumen
    const summaryDiv = document.createElement("div");
    summaryDiv.className = "mt-3 p-3 bg-gray-100 rounded-lg";
    summaryDiv.innerHTML = `
      <p class="text-xs text-gray-600">
        <strong>Resumen:</strong> El modelo ML analiz√≥ ${factors.length} factores principales. 
        La probabilidad de impago del <strong>${probDefault.toFixed(1)}%</strong> 
        ${probDefault > 50 ? "indica alto riesgo basado en patrones del dataset de entrenamiento" : 
          probDefault > 30 ? "est√° en un rango moderado de riesgo" : 
          "indica bajo riesgo de impago"}.
      </p>
    `;
    explanationEl.appendChild(summaryDiv);
  }

  // Event listeners para c√°lculo autom√°tico
  document
    .getElementById("loan_amnt")
    .addEventListener("input", calculateLoanPercent);
  document
    .getElementById("person_income")
    .addEventListener("input", calculateLoanPercent);
  document
    .getElementById("loan_int_rate")
    .addEventListener("input", updateFormSummary);

  // Manejar env√≠o del formulario
  document
    .getElementById("evaluationForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submitBtn");
      const originalText = submitBtn.innerHTML;

      // Validaci√≥n adicional antes de enviar
      const loanAmnt = parseFloat(document.getElementById("loan_amnt").value);
      const income = parseFloat(document.getElementById("person_income").value);

      if (!loanAmnt || loanAmnt <= 0) {
        showToast("Por favor ingrese un monto de pr√©stamo v√°lido", "error");
        return;
      }

      if (!income || income <= 0) {
        showToast("Por favor ingrese un ingreso v√°lido", "error");
        return;
      }

      showLoading(submitBtn);

      try {
        const formData = new FormData(this);
        const data = {};

        // Campos num√©ricos
        const numericFields = [
          "person_age",
          "person_income",
          "person_emp_length",
          "loan_amnt",
          "loan_int_rate",
          "cb_person_cred_hist_length",
          "desired_term_months",
        ];

        formData.forEach((value, key) => {
          if (key === "loan_percent_income") {
            // Ignorar - lo calcularemos despu√©s
            return;
          }
          if (numericFields.includes(key)) {
            if (value && value !== "") {
              data[key] = parseFloat(value);
            }
          } else {
            data[key] = value;
          }
        });

        // IMPORTANTE: Calcular loan_percent_income correctamente
        // El modelo espera un ratio (0.25 = 25%), no un porcentaje
        data.loan_percent_income = data.loan_amnt / data.person_income;

        console.log("Datos enviados:", data); // Para debugging

        const response = await fetch("/api/evaluar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showResult(result);
          showToast("‚úÖ Evaluaci√≥n completada exitosamente", "success");

          // Scroll al resultado en m√≥vil
          if (window.innerWidth < 1024) {
            document
              .getElementById("resultPanel")
              .scrollIntoView({ behavior: "smooth" });
          }
        } else {
          console.error("Error del servidor:", result);
          showToast(result.error || "Error al procesar la evaluaci√≥n", "error");
          if (result.details) {
            result.details.forEach((detail) => showToast(detail, "error"));
          }
        }
      } catch (error) {
        console.error("Error de conexi√≥n:", error);
        showToast("Error de conexi√≥n con el servidor", "error");
      } finally {
        hideLoading(submitBtn, originalText);
      }
    });

  // Calcular al cargar la p√°gina si hay valores
  window.addEventListener("load", function () {
    calculateLoanPercent();
  });
</script>
{% endblock %}
