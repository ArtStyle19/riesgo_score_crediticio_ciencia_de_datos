{% extends "base.html" %} {% set active_page = 'evaluacion' %} {% block title
%}Evaluacion Individual - Sistema de Analisis Crediticio{% endblock %} {% block
content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
  <!-- Formulario de Evaluacion -->
  <div class="lg:col-span-2">
    <div class="glass-card overflow-hidden">
      <!-- Header -->
      <div class="border-b border-white/20 px-6 py-4 bg-white/30">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold text-slate-800">
              Analisis de Riesgo Individual
            </h2>
            <p class="mt-1 text-sm text-slate-500">
              Complete los datos del prestamo para obtener una prediccion de
              riesgo
            </p>
          </div>
          <!-- Heroicon: question-mark-circle -->
          <button
            onclick="toggleHelp()"
            class="p-2 text-slate-400 hover:text-indigo-600 rounded-xl hover:bg-white/50 transition-colors"
            title="Ayuda"
          >
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <!-- Quick Fill Buttons -->
      <div
        class="px-6 py-4 bg-gradient-to-r from-slate-50/80 to-white/60 border-b border-white/20"
      >
        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
          <span class="text-sm font-medium text-slate-700"
            >Ejemplos de prueba:</span
          >
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              onclick="fillExample('low')"
              class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-emerald-100/80 text-emerald-700 hover:bg-emerald-200/80 transition-colors backdrop-blur-sm"
            >
              <!-- Heroicon: check-circle -->
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Riesgo Bajo
            </button>
            <button
              type="button"
              onclick="fillExample('medium')"
              class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-amber-100/80 text-amber-700 hover:bg-amber-200/80 transition-colors backdrop-blur-sm"
            >
              <!-- Heroicon: minus-circle -->
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Riesgo Medio
            </button>
            <button
              type="button"
              onclick="fillExample('high')"
              class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-red-100/80 text-red-700 hover:bg-red-200/80 transition-colors backdrop-blur-sm"
            >
              <!-- Heroicon: exclamation-triangle -->
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
                ></path>
              </svg>
              Riesgo Alto
            </button>
            <button
              type="button"
              onclick="clearForm()"
              class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-slate-100/80 text-slate-600 hover:bg-slate-200/80 transition-colors backdrop-blur-sm"
            >
              <!-- Heroicon: x-circle -->
              <svg
                class="h-4 w-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
              </svg>
              Limpiar
            </button>
          </div>
        </div>
      </div>

      <form id="evaluationForm" class="p-6 space-y-6">
        <!-- Seccion: Informacion del Solicitante -->
        <div
          class="rounded-xl border border-white/30 overflow-hidden glass-light"
        >
          <div
            class="bg-gradient-to-r from-indigo-50/80 to-purple-50/60 px-4 py-3 border-b border-white/30"
          >
            <h3
              class="flex items-center gap-2 text-sm font-semibold text-slate-700"
            >
              <!-- Heroicon: user -->
              <svg
                class="h-5 w-5 text-indigo-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
                ></path>
              </svg>
              Informacion del Solicitante
            </h3>
          </div>
          <div
            class="p-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 bg-white/40"
          >
            <!-- Nombre del Cliente -->
            <div class="space-y-1 sm:col-span-2 lg:col-span-3">
              <label
                class="flex items-center gap-1 text-sm font-medium text-slate-700"
              >
                Nombre del Cliente
                <span class="text-slate-400 text-xs">(opcional)</span>
              </label>
              <input
                type="text"
                name="client_name"
                id="client_name"
                class="form-select block w-full"
                placeholder="Ej: Juan Perez"
              />
              <p class="text-xs text-slate-500">
                Nombre o identificador del solicitante
              </p>
            </div>

            <!-- Edad -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-slate-700"
              >
                Edad
                <span class="text-red-500">*</span>
                <button
                  type="button"
                  onclick="showFieldHelp('age')"
                  class="text-slate-400 hover:text-indigo-600"
                >
                  <svg
                    class="h-4 w-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z"
                    ></path>
                  </svg>
                </button>
              </label>
              <input
                type="number"
                name="person_age"
                id="person_age"
                required
                min="18"
                max="80"
                class="form-select block w-full"
                placeholder="Ej: 35"
              />
              <p class="text-xs text-slate-500">
                Edad del solicitante (18-80 anos)
              </p>
            </div>

            <!-- Ingreso Anual -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-slate-700"
              >
                Ingreso Anual
                <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"
                  >$</span
                >
                <input
                  type="number"
                  name="person_income"
                  id="person_income"
                  required
                  min="0"
                  class="block w-full pl-7"
                  placeholder="50000"
                />
              </div>
              <p class="text-xs text-slate-500">Ingresos anuales en dolares</p>
            </div>

            <!-- Anos de Empleo -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-slate-700"
              >
                Anos de Empleo
                <span class="text-red-500">*</span>
              </label>
              <input
                type="number"
                name="person_emp_length"
                id="person_emp_length"
                required
                min="0"
                max="60"
                step="0.1"
                class="form-select block w-full"
                placeholder="5"
              />
              <p class="text-xs text-slate-500">Tiempo en empleo actual</p>
            </div>

            <!-- Tipo de Vivienda -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Tipo de Vivienda
                <span class="text-red-500">*</span>
              </label>
              <select
                name="person_home_ownership"
                id="person_home_ownership"
                required
                class="form-select block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="RENT">Alquiler</option>
                <option value="OWN">Propia</option>
                <option value="MORTGAGE">Hipoteca</option>
                <option value="OTHER">Otro</option>
              </select>
              <p class="text-xs text-gray-500">Situacion de vivienda actual</p>
            </div>

            <!-- Historial Crediticio -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Anos de Historial
                <span class="text-red-500">*</span>
              </label>
              <input
                type="number"
                name="cb_person_cred_hist_length"
                id="cb_person_cred_hist_length"
                required
                min="0"
                max="50"
                class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
                placeholder="8"
              />
              <p class="text-xs text-gray-500">
                Antiguedad del historial crediticio
              </p>
            </div>

            <!-- Default Previo -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Incumplimiento Previo
                <span class="text-red-500">*</span>
              </label>
              <select
                name="cb_person_default_on_file"
                id="cb_person_default_on_file"
                required
                class="form-select block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="N">No - Sin historial de incumplimiento</option>
                <option value="Y">
                  Si - Tiene historial de incumplimiento
                </option>
              </select>
              <p class="text-xs text-gray-500">
                Registro de mora en buro de credito
              </p>
            </div>
          </div>
        </div>

        <!-- Seccion: Informacion del Prestamo -->
        <div class="rounded-lg border border-gray-200 overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3
              class="flex items-center gap-2 text-sm font-semibold text-gray-700"
            >
              <!-- Heroicon: banknotes -->
              <svg
                class="h-5 w-5 text-green-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                stroke-width="1.5"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"
                ></path>
              </svg>
              Informacion del Prestamo
            </h3>
          </div>
          <div class="p-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
            <!-- Monto del Prestamo -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Monto Solicitado
                <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >$</span
                >
                <input
                  type="number"
                  name="loan_amnt"
                  id="loan_amnt"
                  required
                  min="0"
                  class="block w-full pl-7 rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
                  placeholder="10000"
                />
              </div>
              <p class="text-xs text-gray-500">
                Cantidad del prestamo en dolares
              </p>
            </div>

            <!-- Tasa de Interes -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Tasa de Interes
                <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="number"
                  name="loan_int_rate"
                  id="loan_int_rate"
                  required
                  min="0"
                  max="100"
                  step="0.01"
                  class="block w-full pr-7 rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
                  placeholder="10.5"
                />
                <span
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"
                  >%</span
                >
              </div>
              <p class="text-xs text-gray-500">Tasa de interes anual</p>
            </div>

            <!-- Porcentaje sobre Ingreso -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                % sobre Ingreso
                <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="number"
                  name="loan_percent_income"
                  id="loan_percent_income"
                  required
                  min="0"
                  max="1"
                  step="0.01"
                  class="form-select block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
                  placeholder="0.20"
                />
              </div>
              <p class="text-xs text-gray-500">
                Prestamo / Ingreso (0.0 - 1.0)
              </p>
            </div>

            <!-- Grado del Prestamo -->
            <div class="space-y-1">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Grado de Riesgo
                <span class="text-red-500">*</span>
              </label>
              <select
                name="loan_grade"
                id="loan_grade"
                required
                class="form-select block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
              >
                <option value="">Seleccionar...</option>
                <option value="A">A - Excelente (menor riesgo)</option>
                <option value="B">B - Muy Bueno</option>
                <option value="C">C - Bueno</option>
                <option value="D">D - Regular</option>
                <option value="E">E - Riesgoso</option>
                <option value="F">F - Muy Riesgoso</option>
                <option value="G">G - Alto Riesgo (mayor riesgo)</option>
              </select>
              <p class="text-xs text-gray-500">Clasificacion del prestamo</p>
            </div>

            <!-- Proposito -->
            <div class="space-y-1 sm:col-span-2">
              <label
                class="flex items-center gap-1 text-sm font-medium text-gray-700"
              >
                Proposito del Prestamo
                <span class="text-red-500">*</span>
              </label>
              <select
                name="loan_intent"
                id="loan_intent"
                required
                class="form-select block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm"
              >
                <option value="">Seleccionar el proposito...</option>
                <option value="PERSONAL">Personal - Gastos personales</option>
                <option value="EDUCATION">
                  Educacion - Estudios o capacitacion
                </option>
                <option value="MEDICAL">Medico - Gastos de salud</option>
                <option value="VENTURE">Negocio - Emprendimiento</option>
                <option value="HOMEIMPROVEMENT">
                  Mejora de Hogar - Remodelacion
                </option>
                <option value="DEBTCONSOLIDATION">
                  Consolidacion de Deuda - Pagar otras deudas
                </option>
              </select>
              <p class="text-xs text-gray-500">
                Motivo por el cual se solicita el prestamo
              </p>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div
          class="flex items-center justify-end gap-4 pt-4 border-t border-gray-200"
        >
          <button
            type="button"
            onclick="clearForm()"
            class="px-4 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Limpiar Formulario
          </button>
          <button
            type="submit"
            id="submitBtn"
            class="inline-flex items-center gap-2 px-6 py-2.5 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors"
          >
            <!-- Heroicon: sparkles -->
            <svg
              class="h-5 w-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"
              ></path>
            </svg>
            Analizar Riesgo
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Panel de Resultados -->
  <div class="lg:col-span-1">
    <!-- Resultado -->
    <div id="resultPanel" class="glass-card overflow-hidden">
      <div
        class="border-b border-white/20 px-6 py-4 bg-gradient-to-r from-slate-50/80 to-white/60"
      >
        <h3 class="text-lg font-semibold text-slate-800">
          Resultado del Analisis
        </h3>
      </div>

      <!-- Estado Inicial -->
      <div id="initialState" class="p-8 text-center bg-white/40">
        <!-- Heroicon: document-magnifying-glass -->
        <svg
          class="mx-auto h-16 w-16 text-slate-300"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          stroke-width="1"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5-15H5.625c-.621 0-1.125.504-1.125 1.125v16.5c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9zm3.75 11.625a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"
          ></path>
        </svg>
        <p class="mt-4 text-sm text-gray-500">
          Complete el formulario y haga clic en "Analizar Riesgo" para ver los
          resultados
        </p>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="hidden p-8 text-center">
        <div class="relative mx-auto h-16 w-16">
          <div
            class="absolute inset-0 rounded-full border-4 border-gray-200"
          ></div>
          <div
            class="absolute inset-0 rounded-full border-4 border-primary-600 border-t-transparent animate-spin"
          ></div>
        </div>
        <p class="mt-4 text-sm text-slate-500">
          Analizando datos del prestamo...
        </p>
      </div>

      <!-- Result Content -->
      <div id="resultContent" class="hidden">
        <!-- Risk Level Badge -->
        <div id="riskBadge" class="px-6 py-8 text-center">
          <!-- Content filled by JS -->
        </div>

        <!-- Probability Section -->
        <div class="px-6 pb-6 space-y-4 bg-white/40">
          <div>
            <div class="flex items-center justify-between text-sm mb-1">
              <span class="text-slate-600">Probabilidad de Pago</span>
              <span class="font-semibold text-emerald-600" id="paymentProb"
                >-</span
              >
            </div>
            <div
              class="h-2.5 bg-slate-200/60 rounded-full overflow-hidden backdrop-blur-sm"
            >
              <div
                id="paymentBar"
                class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500 transition-all duration-500 rounded-full"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between text-sm mb-1">
              <span class="text-slate-600">Probabilidad de Incumplimiento</span>
              <span class="font-semibold text-red-600" id="defaultProb">-</span>
            </div>
            <div
              class="h-2.5 bg-slate-200/60 rounded-full overflow-hidden backdrop-blur-sm"
            >
              <div
                id="defaultBar"
                class="h-full bg-gradient-to-r from-red-400 to-red-500 transition-all duration-500 rounded-full"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>

        <!-- Risk Factors -->
        <div class="border-t border-white/30 px-6 py-4 bg-white/30">
          <h4
            class="text-sm font-semibold text-slate-700 mb-3 flex items-center gap-2"
          >
            <!-- Heroicon: light-bulb -->
            <svg
              class="h-4 w-4 text-amber-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              stroke-width="1.5"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.383a14.406 14.406 0 01-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 10-7.517 0c.85.493 1.509 1.333 1.509 2.316V18"
              ></path>
            </svg>
            Factores de Riesgo Identificados
          </h4>
          <ul id="riskFactors" class="space-y-2 text-sm">
            <!-- Content filled by JS -->
          </ul>
        </div>

        <!-- Confidence -->
        <div
          class="border-t border-white/30 px-6 py-4 bg-gradient-to-r from-slate-50/80 to-white/60"
        >
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">Confianza del modelo</span>
            <span class="text-sm font-semibold text-slate-800" id="confidence"
              >-</span
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Info Card -->
    <div class="mt-6 glass-card p-4 border border-primary-200/50">
      <div class="flex gap-3">
        <!-- Heroicon: information-circle -->
        <svg
          class="h-5 w-5 text-primary-600 flex-shrink-0 mt-0.5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"
          ></path>
        </svg>
        <div>
          <h4 class="text-sm font-medium text-primary-800">Interpretacion</h4>
          <ul class="mt-2 text-xs text-primary-700 space-y-1">
            <li>
              <span class="font-semibold">Riesgo Bajo:</span> Alta probabilidad
              de pago completo
            </li>
            <li>
              <span class="font-semibold">Riesgo Medio:</span> Requiere
              seguimiento y monitoreo
            </li>
            <li>
              <span class="font-semibold">Riesgo Alto:</span> Alta probabilidad
              de incumplimiento
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Example data for quick fill
  const EXAMPLES = {
    low: {
      person_age: 35,
      person_income: 75000,
      person_emp_length: 8,
      person_home_ownership: "OWN",
      cb_person_cred_hist_length: 12,
      cb_person_default_on_file: "N",
      loan_amnt: 10000,
      loan_int_rate: 8.5,
      loan_percent_income: 0.13,
      loan_grade: "A",
      loan_intent: "HOMEIMPROVEMENT",
    },
    medium: {
      person_age: 28,
      person_income: 45000,
      person_emp_length: 3,
      person_home_ownership: "RENT",
      cb_person_cred_hist_length: 5,
      cb_person_default_on_file: "N",
      loan_amnt: 12000,
      loan_int_rate: 12.5,
      loan_percent_income: 0.27,
      loan_grade: "C",
      loan_intent: "PERSONAL",
    },
    high: {
      person_age: 22,
      person_income: 22000,
      person_emp_length: 1,
      person_home_ownership: "RENT",
      cb_person_cred_hist_length: 2,
      cb_person_default_on_file: "Y",
      loan_amnt: 15000,
      loan_int_rate: 18.5,
      loan_percent_income: 0.68,
      loan_grade: "E",
      loan_intent: "DEBTCONSOLIDATION",
    },
  };

  function fillExample(type) {
    const example = EXAMPLES[type];
    if (!example) return;

    Object.keys(example).forEach((key) => {
      const input = document.getElementById(key);
      if (input) {
        input.value = example[key];
      }
    });

    showToast(
      `Formulario llenado con ejemplo de riesgo ${
        type === "low" ? "bajo" : type === "medium" ? "medio" : "alto"
      }`,
      "info"
    );
  }

  function clearForm() {
    document.getElementById("evaluationForm").reset();
    document.getElementById("initialState").classList.remove("hidden");
    document.getElementById("loadingState").classList.add("hidden");
    document.getElementById("resultContent").classList.add("hidden");
  }

  document
    .getElementById("evaluationForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const initialState = document.getElementById("initialState");
      const loadingState = document.getElementById("loadingState");
      const resultContent = document.getElementById("resultContent");
      const submitBtn = document.getElementById("submitBtn");

      // Show loading
      initialState.classList.add("hidden");
      loadingState.classList.remove("hidden");
      resultContent.classList.add("hidden");
      submitBtn.disabled = true;

      // Collect form data
      const formData = new FormData(this);
      const data = {};
      const clientName = formData.get("client_name") || "";
      formData.forEach((value, key) => {
        if (key !== "client_name") {
          data[key] = isNaN(value) ? value : parseFloat(value);
        }
      });

      try {
        const response = await fetch("/api/evaluar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          displayResult(result.result);

          // Calcular campos adicionales para el historial
          const probDefault = result.result.probability_default || 0.5;
          const creditScore = Math.round(850 - probDefault * 550);
          const riskLevel = result.result.risk_level;
          const loanAmount = parseFloat(data.loan_amnt);

          let decision, approvedAmount;
          if (riskLevel === "BAJO") {
            decision = "APROBADO";
            approvedAmount = loanAmount;
          } else if (riskLevel === "MEDIO") {
            decision = "APROBADO CON CONDICIONES";
            approvedAmount = loanAmount * 0.8;
          } else {
            decision = "RECHAZADO";
            approvedAmount = 0;
          }

          let scoreCategory;
          if (creditScore >= 740) scoreCategory = "Excelente";
          else if (creditScore >= 670) scoreCategory = "Bueno";
          else if (creditScore >= 580) scoreCategory = "Regular";
          else scoreCategory = "Malo";

          // Guardar en historial
          saveToHistory({
            client_name: clientName || "Sin nombre",
            person_age: data.person_age,
            person_income: data.person_income,
            loan_amnt: data.loan_amnt,
            loan_intent: data.loan_intent,
            loan_grade: data.loan_grade,
            loan_int_rate: data.loan_int_rate,
            person_home_ownership: data.person_home_ownership,
            person_emp_length: data.person_emp_length,
            cb_person_cred_hist_length: data.cb_person_cred_hist_length,
            cb_person_default_on_file: data.cb_person_default_on_file,
            risk_level: result.result.risk_level,
            probability_default: result.result.probability_default,
            probability_payment: result.result.probability_payment,
            prediction: result.result.prediction,
            confidence: result.result.confidence,
            credit_score: creditScore,
            score_category: scoreCategory,
            decision: decision,
            approved_amount: approvedAmount,
            source: "individual",
          });
          showToast("Evaluacion guardada en historial", "success");
        } else {
          showToast("Error: " + result.error, "error");
          initialState.classList.remove("hidden");
        }
      } catch (error) {
        showToast("Error de conexion: " + error.message, "error");
        initialState.classList.remove("hidden");
      } finally {
        loadingState.classList.add("hidden");
        submitBtn.disabled = false;
      }
    });

  // Funcion para guardar en historial (localStorage)
  function saveToHistory(evaluation) {
    const KEY = "credit_risk_evaluations";
    try {
      let history = JSON.parse(localStorage.getItem(KEY) || "[]");
      const newEval = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        ...evaluation,
      };
      history.unshift(newEval);
      // Mantener maximo 1000 registros
      if (history.length > 1000) {
        history = history.slice(0, 1000);
      }
      localStorage.setItem(KEY, JSON.stringify(history));
    } catch (e) {
      console.error("Error guardando en historial:", e);
    }
  }

  function displayResult(result) {
    const resultContent = document.getElementById("resultContent");

    // Risk badge con estilos glassmorphism
    const riskBadge = document.getElementById("riskBadge");
    const riskConfig = {
      BAJO: {
        bg: "bg-gradient-to-br from-emerald-100/90 to-green-50/80",
        text: "text-emerald-700",
        glow: "shadow-lg shadow-emerald-200/50",
        icon: '<svg class="h-12 w-12 mx-auto mb-3 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        title: "RIESGO BAJO",
        subtitle: "Alta probabilidad de pago",
      },
      MEDIO: {
        bg: "bg-gradient-to-br from-amber-100/90 to-yellow-50/80",
        text: "text-amber-700",
        glow: "shadow-lg shadow-amber-200/50",
        icon: '<svg class="h-12 w-12 mx-auto mb-3 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"></path></svg>',
        title: "RIESGO MEDIO",
        subtitle: "Requiere seguimiento",
      },
      ALTO: {
        bg: "bg-gradient-to-br from-red-100/90 to-rose-50/80",
        text: "text-red-700",
        glow: "shadow-lg shadow-red-200/50",
        icon: '<svg class="h-12 w-12 mx-auto mb-3 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"></path></svg>',
        title: "RIESGO ALTO",
        subtitle: "Alta probabilidad de incumplimiento",
      },
    };

    const config = riskConfig[result.risk_level];
    riskBadge.className = `px-6 py-8 text-center ${config.bg} ${config.glow} backdrop-blur-sm`;
    riskBadge.innerHTML = `
        <div class="${config.text}">
            ${config.icon}
            <h3 class="text-2xl font-bold tracking-wide">${config.title}</h3>
            <p class="text-sm mt-1 opacity-75">${config.subtitle}</p>
        </div>
    `;

    // Probabilities
    const paymentProb = (result.probability_payment * 100).toFixed(1);
    const defaultProb = (result.probability_default * 100).toFixed(1);

    document.getElementById("paymentProb").textContent = paymentProb + "%";
    document.getElementById("defaultProb").textContent = defaultProb + "%";
    document.getElementById("paymentBar").style.width = paymentProb + "%";
    document.getElementById("defaultBar").style.width = defaultProb + "%";

    // Risk factors - colores dinámicos según nivel de riesgo
    const factorsList = document.getElementById("riskFactors");
    factorsList.innerHTML = "";

    // Colores según el nivel de riesgo
    const riskColors = {
      BAJO: {
        positive: "text-emerald-600",
        negative: "text-slate-500",
        bg: "bg-emerald-50",
      },
      MEDIO: {
        positive: "text-emerald-600",
        negative: "text-amber-600",
        bg: "bg-amber-50",
      },
      ALTO: {
        positive: "text-emerald-600",
        negative: "text-red-600",
        bg: "bg-red-50",
      },
    };
    const colors = riskColors[result.risk_level] || riskColors.MEDIO;

    if (result.risk_factors && result.risk_factors.length > 0) {
      result.risk_factors.forEach((factor) => {
        const isPositive =
          factor.impact === "positive" || factor.type === "positive";
        const li = document.createElement("li");
        li.className = `flex items-start gap-2 p-2 rounded-lg ${
          isPositive
            ? colors.positive + " bg-emerald-50/50"
            : colors.negative + " " + colors.bg + "/50"
        }`;
        li.innerHTML = `
                <svg class="h-4 w-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    ${
                      isPositive
                        ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>'
                        : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>'
                    }
                </svg>
                <span class="text-sm">${
                  factor.description || factor.factor
                }</span>
            `;
        factorsList.appendChild(li);
      });
    } else {
      factorsList.innerHTML =
        '<li class="text-slate-400 text-sm italic">No se identificaron factores especificos</li>';
    }

    // Confidence
    document.getElementById("confidence").textContent =
      (result.confidence * 100).toFixed(1) + "%";

    // Show result
    resultContent.classList.remove("hidden");
  }

  function showToast(message, type = "info") {
    const colors = {
      success: "bg-green-500",
      error: "bg-red-500",
      info: "bg-blue-500",
      warning: "bg-amber-500",
    };

    const toast = document.createElement("div");
    toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-y-full`;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => toast.classList.remove("translate-y-full"), 10);
    setTimeout(() => {
      toast.classList.add("translate-y-full");
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
</script>
{% endblock %}
